<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéØ LƒÉng k√≠nh ng∆∞·ªùi ti√™u d√πng</title>
<style>
  body { font-family:"Segoe UI",Arial,sans-serif; background:linear-gradient(120deg,#fff8dc,#ffe4e6); text-align:center; margin:0; padding:20px;}
  h1 { color:#6d28d9; }
  #game-container { background:white; border-radius:20px; box-shadow:0 4px 10px rgba(0,0,0,0.15); display:inline-block; padding:20px; max-width:500px; width:100%; }
  img { max-width:100%; border-radius:15px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
  button { padding:10px 20px; border:none; border-radius:10px; margin:5px; background-color:#7c3aed; color:white; font-weight:bold; cursor:pointer; transition:0.3s;}
  button:hover { background-color:#5b21b6;}
  select, input { padding:10px; border-radius:8px; border:1px solid #ccc; width:80%; margin-top:5px; margin-bottom:10px;}
  #result{font-size:18px;font-weight:bold;margin-top:15px;}
  #score{font-size:18px;font-weight:bold;color:#16a34a;margin-top:10px;}
  #timer{font-size:18px;font-weight:bold;color:#dc2626;margin-bottom:10px;}
  table { width:100%; border-collapse:collapse; margin-top:15px; overflow-x: auto;}
  th, td { border:1px solid #ccc; padding:8px; font-size:14px;}
  th { background:#7c3aed; color:white;}
  #ranking-container { margin-top:20px; }
</style>
</head>
<body>

<h1>üè≠ LƒÉng k√≠nh ng∆∞·ªùi ti√™u d√πng</h1>

<div id="menu">
  <h3>Nh·∫≠p t√™n c·ªßa b·∫°n:</h3>
  <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n...">
  <h2>Ch·ªçn ch·∫ø ƒë·ªô ch∆°i</h2>
  <button onclick="startGame('sanpham')">ü•Ø S·∫£n ph·∫©m</button>
  <button onclick="startGame('baobi1')">üì¶ Bao b√¨ c·∫•p 1</button>
  <button onclick="startGame('baobi2')">üì¶ Bao b√¨ c·∫•p 2</button>
</div>

<div id="game-container" style="display:none;">
  <div id="timer">Th·ªùi gian: 20s</div>
  <img id="biscuitImage" src="" alt="·∫¢nh l·ªói QC">
  <div>
    <button onclick="checkAnswer(true)">‚úÖ ƒê·∫°t</button>
    <button onclick="checkAnswer(false)">‚ùå L·ªói</button>
  </div>
  <div id="errorSection" style="display:none;">
    <p>Ch·ªçn lo·∫°i l·ªói:</p>
    <select id="errorSelect"></select>
    <br>
    <button onclick="submitError()">X√°c nh·∫≠n</button>
  </div>
  <div id="result"></div>
  <div id="score">ƒêi·ªÉm: 0</div>
  <br>
  <button onclick="nextImage()">üëâ ·∫¢nh ti·∫øp theo</button>
</div>

<!-- B·∫£ng x·∫øp h·∫°ng -->
<div id="ranking-container">
  <h2>üèÜ B·∫£ng x·∫øp h·∫°ng TOP 10</h2>
  <select id="rankingModeSelect" onchange="updateRankingByMode()">
    <option value="">T·∫•t c·∫£</option>
    <option value="sanpham">S·∫£n ph·∫©m</option>
    <option value="baobi1">Bao b√¨ c·∫•p 1</option>
    <option value="baobi2">Bao b√¨ c·∫•p 2</option>
  </select>
  <table id="rankingTable"></table>
</div>

<script>
// --- URL Web App ---
const scriptURL = "https://script.google.com/macros/s/AKfycbzY2g5F8OmEgS_TNGLPYxkC_upeURQfpdKNesFngSSRdf6Vmqj3nrWqrdFzPSE1pqaGLw/exec";

// --- Map code mode ‚Üí t√™n ƒë·∫ßy ƒë·ªß ---
const modeNameMap = {
  sanpham: "S·∫£n ph·∫©m",
  baobi1: "Bao b√¨ c·∫•p 1",
  baobi2: "Bao b√¨ c·∫•p 2"
};

// --- D·ªØ li·ªáu ·∫£nh ---
const baseURL = "https://lehienbqc53-cpu.github.io/Mygame/Anh/";

const productErrors = [
  { src:"Banh_Be_Vo.webp", correctError:"B√°nh b·ªÉ v·ª°" },
  { src:"Banh_Khuyet.webp", correctError:"B√°nh khuy·∫øt" },
  { src:"Banh_Loi_Cong_Dau.webp", correctError:"B√°nh cong ƒë·∫ßu" },
  { src:"Banh_Loi_Dinh_Nhau.webp", correctError:"B√°nh d√≠nh nhau" },
  { src:"Banh_Loi_Khong_Dau.webp", correctError:"B√°nh kh√¥ng d·∫ßu" },
  { src:"Banh_Mau_Sac_Khong_Dat.webp", correctError:"M√†u s·∫Øc kh√¥ng ƒë·∫°t" },
  { src:"Banh_Rop_Mat.webp", correctError:"R·ªôp m·∫∑t" },
  { src:"Banh_Sut_Mat_Mieng.webp", correctError:"S·ª©t m·∫•t mi·∫øng" }
];

const pack1Errors = [
  { src:"Sai_Date_Code.webp", correctError:"Sai date code" },
  { src:"Bang_Keo_Noi_Cuon.webp", correctError:"BƒÉng keo n·ªëi cu·ªôn" },
  { src:"Can_Trang.webp", correctError:"C·∫•n tr·∫Øng" },
  { src:"Duong_Han_Bi_Hu_Hai.webp", correctError:"ƒê∆∞·ªùng h√†n b·ªã h∆∞ h·∫°i" },
  { src:"Duong_Han_Can_Rach.webp", correctError:"ƒê∆∞·ªùng h√†n c·∫•n r√°ch" },
  { src:"Duong_Han_Qua_Nhiet.webp", correctError:"ƒê∆∞·ªùng h√†n qu√° nhi·ªát" },
  { src:"Duong_Han_Yeu.webp", correctError:"ƒê∆∞·ªùng h√†n y·∫øu" },
  { src:"Xep_Ly.webp", correctError:"X·∫øp ly" },
  { src:"Xep_Ly_xi.webp", correctError:"X·∫øp ly x√¨" },
  { src:"Kep_Banh_Duong_Han.webp", correctError:"K·∫πp b√°nh ƒë∆∞·ªùng h√†n" },
  { src:"Lech_Bao_Bi.webp", correctError:"L·ªách bao b√¨" }
];

const pack2Errors = [
  { src:"Bang_Keo_Nhan_Khong_Du_chieu_dai.webp", correctError:"BƒÉng keo nhƒÉn kh√¥ng ƒë·ªß chi·ªÅu d√†i" },
  { src:"Hop_Bung_Keo.webp", correctError:"H·ªôp bung keo" },
  { src:"Hop_Dan_Tho_Tai.webp", correctError:"H·ªôp d√°n th√≤ tai" },
  { src:"Hop_Lem_Keo.webp", correctError:"H·ªôp lem keo" },
  { src:"Khe_Ho_Nap_Thung.webp", correctError:"Khe h·ªü n·∫Øp th√πng" },
  { src:"Lech_Nap_Thung.webp", correctError:"L·ªách n·∫Øp th√πng" },
  { src:"Mop_Gay_Hop.webp", correctError:"M√≥p g√£y h·ªôp" },
  { src:"Rach_Goc_Hop.webp", correctError:"R√°ch g√≥c h·ªôp" },
  { src:"Sai_Date_Thung.webp", correctError:"Sai date th√πng" },
  { src:"Sai_Quy_Cach_Xep.webp", correctError:"Sai quy c√°ch x·∫øp" },
  { src:"Thieu_Banh.webp", correctError:"Thi·∫øu b√°nh" },
  { src:"Thieu_Thung_Tren_Palet.webp", correctError:"Thi·∫øu th√πng tr√™n pallet" },
  { src:"Thung_Mop_Meo.webp", correctError:"Th√πng m√≥p m√©o" },
  { src:"Tray_Xuoc_Hop.webp", correctError:"Tray x∆∞·ªõc h·ªôp" },
  { src:"Hop_Bi_Ho.webp", correctError:"H·ªôp b·ªã h·ªü" },
  { src:"Dan_Lech.webp", correctError:"D√°n l·ªách" }
];

const errorOptions = {
  sanpham: productErrors.map(e=>e.correctError),
  baobi1: pack1Errors.map(e=>e.correctError),
  baobi2: pack2Errors.map(e=>e.correctError)
};

let images=[], mode="", current=0, score=0, answered=false, timeLeft=20, timerInterval, playerName="";
const imgElement=document.getElementById("biscuitImage");
const resultElement=document.getElementById("result");
const errorSection=document.getElementById("errorSection");
const scoreElement=document.getElementById("score");
const timerElement=document.getElementById("timer");
const menu=document.getElementById("menu");
const gameContainer=document.getElementById("game-container");
const errorSelect=document.getElementById("errorSelect");

// ----------------------
// POST ƒëi·ªÉm l√™n Google Sheet
// ----------------------
async function saveScore(playerName, mode, score){
  try{
    await fetch(scriptURL,{
      method:"POST",
      mode:"no-cors",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ten_nguoi_choi:playerName,muc_choi:mode,diem:score})
    });
  }catch(err){ console.error("POST l·ªói:",err); }
}

// ----------------------
// L·∫•y b·∫£ng x·∫øp h·∫°ng
// ----------------------
async function getRanking(){
  try{
    const res=await fetch(scriptURL+"?action=getRanking");
    return await res.json();
  }catch(err){ console.error("GET l·ªói:",err); return []; }
}

// ----------------------
// Game functions
// ----------------------
function shuffleArray(array){ for(let i=array.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [array[i],array[j]]=[array[j],array[i]]; } }

function startGame(selectedMode){
  playerName=document.getElementById("playerName").value.trim();
  if(!playerName){ alert("H√£y nh·∫≠p t√™n!"); return; }
  mode=selectedMode;

  const baseErrors = mode==="sanpham"?productErrors:mode==="baobi1"?pack1Errors:pack2Errors;
  const timestamp="?v="+Date.now();
  images=baseErrors.map(img=>({...img, src:baseURL+img.src+timestamp, isGood:false}));

  if(mode==="sanpham"){ images.push({src:baseURL+"Banh_Dat_1.webp"+timestamp,isGood:true},{src:baseURL+"Banh_Dat_2.webp"+timestamp,isGood:true}); }
  else if(mode==="baobi1"){ images.push({src:baseURL+"Bao_Bi_Cap_1_Dat.webp"+timestamp,isGood:true}); }
  else{ images.push({src:baseURL+"Bao_Bi_Cap_2_Dat.webp"+timestamp,isGood:true}); }

  shuffleArray(images);
  menu.style.display="none"; gameContainer.style.display="block";
  loadErrorOptions(); loadImage();
}

function loadErrorOptions(){
  errorSelect.innerHTML="<option value=''>-- Ch·ªçn lo·∫°i l·ªói --</option>";
  errorOptions[mode].forEach(opt=>{ const option=document.createElement("option"); option.value=opt; option.textContent=opt; errorSelect.appendChild(option); });
}

function startTimer(){
  timerElement.textContent=`Th·ªùi gian: ${timeLeft}s`;
  timerInterval=setInterval(()=>{
    timeLeft--; timerElement.textContent=`Th·ªùi gian: ${timeLeft}s`;
    if(timeLeft<=0){ clearInterval(timerInterval); resultElement.textContent="‚è∞ H·∫øt th·ªùi gian!"; answered=true; errorSection.style.display="none"; setTimeout(nextImage,1500); }
  },1000);
}

function checkAnswer(isGoodSelected){
  if(answered) return;
  const currentImg=images[current];
  if(currentImg.isGood){ resultElement.textContent="üéâ Ch√≠nh x√°c! ƒê√¢y l√† ·∫£nh ƒë·∫°t!"; score++; scoreElement.textContent="ƒêi·ªÉm: "+score; answered=true; clearInterval(timerInterval); errorSection.style.display="none"; }
  else{ if(!isGoodSelected){ resultElement.textContent="‚ùó ƒê√¢y l√† l·ªói, ch·ªçn lo·∫°i l·ªói!"; errorSection.style.display="block"; } else{ resultElement.textContent="‚ùå Sai r·ªìi!"; errorSection.style.display="none"; } }
}

function submitError(){
  const selected=errorSelect.value;
  const currentImg=images[current];
  if(!selected){ resultElement.textContent="‚ö†Ô∏è Ch·ªçn lo·∫°i l·ªói!"; return; }
  if(selected===currentImg.correctError){ resultElement.textContent="‚úÖ Ch√≠nh x√°c!"; score++; } 
  else{ resultElement.textContent="‚ùå Sai lo·∫°i l·ªói."; }
  scoreElement.textContent="ƒêi·ªÉm: "+score;
  answered=true; errorSection.style.display="none"; clearInterval(timerInterval);
}

function nextImage(){ if(current<images.length-1){ current++; loadImage(); } else{ showFinalScore(); } }

function loadImage(){ const currentImg=images[current]; imgElement.src=currentImg.src; resultElement.textContent=""; errorSection.style.display="none"; errorSelect.value=""; answered=false; clearInterval(timerInterval); timeLeft=20; startTimer(); }

// ----------------------
// Hi·ªÉn th·ªã k·∫øt qu·∫£ cu·ªëi
// ----------------------
async function showFinalScore(){
  clearInterval(timerInterval);
  
  // Hi·ªÉn th·ªã ƒëi·ªÉm cu·ªëi
  document.getElementById("score").textContent = `ƒêi·ªÉm cu·ªëi: ${score}/${images.length}`;

  // G·ªçi l∆∞u ƒëi·ªÉm
  await saveScore(playerName, mode, score);

  // C·∫≠p nh·∫≠t b·∫£ng x·∫øp h·∫°ng ngay trong game
  await updateRankingByMode();

  // Th√™m n√∫t ch∆°i l·∫°i
  if(!document.getElementById("restartBtn")){
    const btn = document.createElement("button");
    btn.id = "restartBtn";
    btn.textContent = "üîÑ Ch∆°i l·∫°i";
    btn.onclick = ()=>location.reload();
    document.getElementById("game-container").appendChild(btn);
  }
}


// ----------------------
// Update b·∫£ng x·∫øp h·∫°ng
// ----------------------
async function updateRankingByMode(){
  const selectedMode = document.getElementById("rankingModeSelect").value;
  const ranking = await getRanking();
  const filtered = selectedMode ? ranking.filter(r => r.mode===selectedMode) : ranking;
  const rankingTable = document.getElementById("rankingTable");
  let tableHTML = `<tr><th>H·∫°ng</th><th>T√™n</th><th>M·ª•c ch∆°i</th><th>ƒêi·ªÉm</th></tr>`;
  filtered.slice(0,10).forEach((r,i)=>{
    const displayMode = modeNameMap[r.mode] || r.mode;
    tableHTML+=`<tr><td>${i+1}</td><td>${r.name}</td><td>${displayMode}</td><td>${r.score}</td></tr>`;
  });
  rankingTable.innerHTML = tableHTML;
}

// Refresh b·∫£ng x·∫øp h·∫°ng m·ªói 10s
setInterval(updateRankingByMode, 10000);
updateRankingByMode();
</script>
</body>
</html>

